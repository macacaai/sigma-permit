{% extends "base.html" %}

{% block title %}Licenses - Sigma Permit{% endblock %}

{% block page_title %}Licenses{% endblock %}

{% block page_subtitle %}Manage license keys for tenants{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted mb-0">Issue and manage license keys for tenant organizations</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLicenseModal">
        <i class="bx bx-plus me-2"></i>Create License
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="tenant-filter" class="form-label">Filter by Tenant</label>
                <select class="form-select" id="tenant-filter" onchange="filterLicenses()">
                    <option value="">All Tenants</option>
                    <!-- Tenant options will be loaded dynamically -->
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bx bx-x me-1"></i>Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Licenses List -->
<div class="card">
    <div class="card-body">
        <div id="licenses-list" hx-get="/api/licenses?page=1&size=10" hx-trigger="load, licensesUpdated from:body">
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading licenses...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add License Modal -->
<div class="modal fade" id="addLicenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-plus-circle me-2"></i>Create New License
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form hx-post="/api/licenses" hx-swap="none" hx-boost="false" onsubmit="return false" hx-on:htmx:after-request="if(event.detail.successful) { document.getElementById('addLicenseModal').querySelector('form').reset(); $('#addLicenseModal').modal('hide'); htmx.trigger('body', 'licensesUpdated'); showToast('License created successfully', 'success'); } else { showToast('Failed to create license', 'error'); }">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="tenant_id" class="form-label">Tenant</label>
                            <select class="form-select" id="tenant_id" name="tenant_id" required>
                                <option value="">Select a tenant...</option>
                                <!-- Tenant options will be loaded dynamically -->
                            </select>
                            <div class="form-text">Choose the tenant organization for this license</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="issued_at" class="form-label">Issued At</label>
                            <input type="datetime-local" class="form-control" id="issued_at" name="issued_at" required>
                            <div class="form-text">When was this license issued?</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="template-select" class="form-label">Use Template (Optional)</label>
                            <select class="form-select" id="template-select" onchange="loadTemplateData()">
                                <option value="">Custom License</option>
                                <!-- Template options will be loaded dynamically -->
                            </select>
                            <div class="form-text">Select a template to pre-fill license data</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="payload" class="form-label">License Payload (JSON)</label>
                        <textarea class="form-control font-monospace" id="payload" name="payload" rows="12" placeholder='{
  "features": ["feature1", "feature2"],
  "validity_days": 365,
  "issued_at": "2025-01-01"
}' required></textarea>
                        <div class="form-text">License data in JSON format. Use a template above to get started.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bx bx-info-circle me-1"></i>
                        <strong>Note:</strong> Ensure the license payload complies with your tenant's license limits and any applicable validation rules.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bx bx-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bx bx-key me-1"></i>Create License
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View License Modal -->
<div class="modal fade" id="viewLicenseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-show me-2"></i>License Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="license-details">
                    <!-- License details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bx bx-x me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit License Modal -->
<div class="modal fade" id="editLicenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-edit me-2"></i>Edit License
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form hx-put="/api/licenses/{license_id}" hx-on:htmx:after-request="if(event.detail.successful) { $('#editLicenseModal').modal('hide'); htmx.trigger('body', 'licensesUpdated'); showToast('License updated successfully', 'success'); } else { showToast('Failed to update license', 'error'); }">
                <input type="hidden" name="license_id" id="edit_license_id">
                <div class="modal-body">
                    <input type="hidden" id="edit_license_id" name="license_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_tenant_id" class="form-label">Tenant</label>
                            <select class="form-select" id="edit_tenant_id" name="tenant_id" required>
                                <option value="">Select a tenant...</option>
                                <!-- Tenant options will be loaded dynamically -->
                            </select>
                            <div class="form-text">Choose the tenant organization for this license</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_issue_date" class="form-label">Issue Date</label>
                            <input type="datetime-local" class="form-control" id="edit_issue_date" name="issue_date" required>
                            <div class="form-text">When was this license issued?</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_payload" class="form-label">License Payload (JSON)</label>
                        <textarea class="form-control font-monospace" id="edit_payload" name="payload" rows="12" required></textarea>
                        <div class="form-text">License data in JSON format</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bx bx-info-circle me-1"></i>
                        <strong>Note:</strong> Ensure the license payload complies with your tenant's license limits and any applicable validation rules.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bx bx-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bx bx-save me-1"></i>Update License
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLicenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bx bx-error-circle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to revoke license <strong id="delete-license-id"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bx bx-info-circle me-1"></i>
                    This action cannot be undone. The license will become invalid immediately.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bx bx-x me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirm-delete-license-btn">
                    <i class="bx bx-trash me-1"></i>Revoke License
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let licenseToDelete = null;
let allTenants = [];
let allTemplates = [];

async function loadTenantsAndTemplates() {
    try {
        const [tenantsRes, templatesRes] = await Promise.all([
            fetch('/api/tenants?page=1&size=100'),
            fetch('/api/templates?page=1&size=100')
        ]);

        const tenantsData = await tenantsRes.json();
        const templatesData = await templatesRes.json();

        allTenants = tenantsData.items || [];
        allTemplates = templatesData.items || [];

        // Populate tenant filter
        const tenantFilter = document.getElementById('tenant-filter');
        const tenantSelect = document.getElementById('tenant_id');
        const editTenantSelect = document.getElementById('edit_tenant_id');
        const templateSelect = document.getElementById('template-select');

        tenantFilter.innerHTML = '<option value="">All Tenants</option>';
        tenantSelect.innerHTML = '<option value="">Select a tenant...</option>';
        editTenantSelect.innerHTML = '<option value="">Select a tenant...</option>';
        templateSelect.innerHTML = '<option value="">Custom License</option>';

        allTenants.forEach(tenant => {
            tenantFilter.innerHTML += `<option value="${tenant.id}">${tenant.name}</option>`;
            tenantSelect.innerHTML += `<option value="${tenant.id}">${tenant.name}</option>`;
            editTenantSelect.innerHTML += `<option value="${tenant.id}">${tenant.name}</option>`;
        });

        allTemplates.forEach(template => {
            if (template.is_active) {
                templateSelect.innerHTML += `<option value="${template.id}">${template.name}</option>`;
            }
        });

        // Set default issued_at to current datetime
        setDefaultIssuedAt();
    } catch (error) {
        console.error('Error loading tenants and templates:', error);
    }
}

function setDefaultIssuedAt() {
    const now = new Date();
    const formatted = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
    document.getElementById('issued_at').value = formatted;
}

function loadTemplateData() {
    const templateId = document.getElementById('template-select').value;
    const payloadTextarea = document.getElementById('payload');

    if (!templateId) {
        payloadTextarea.placeholder = '{\n  "features": ["feature1", "feature2"],\n  "validity_days": 365,\n  "issued_at": "2025-01-01"\n}';
        return;
    }

    const template = allTemplates.find(t => t.id == templateId);
    if (template && template.payload_schema) {
        // Create a sample payload based on the schema
        const samplePayload = generateSamplePayload(template.payload_schema);
        payloadTextarea.value = JSON.stringify(samplePayload, null, 2);
    }
}

function generateSamplePayload(schema) {
    const payload = {};

    if (schema.properties) {
        for (const [key, prop] of Object.entries(schema.properties)) {
            if (prop.type === 'string') {
                payload[key] = `sample_${key}`;
            } else if (prop.type === 'integer') {
                payload[key] = prop.minimum || 1;
            } else if (prop.type === 'boolean') {
                payload[key] = true;
            } else if (prop.type === 'array' && prop.items) {
                payload[key] = prop.items.type === 'string' ? [`sample_${key}_1`, `sample_${key}_2`] : [];
            } else {
                payload[key] = `sample_${key}`;
            }
        }
    }

    return payload;
}

function viewLicense(button) {
    const id = button.dataset.id;
    // In a real application, you'd fetch the full license details
    // For now, just show the payload
    const payload = button.dataset.payload;
    document.getElementById('license-details').innerHTML = `
        <h6>License ID: ${id}</h6>
        <pre class="bg-light p-3 rounded"><code>${JSON.stringify(JSON.parse(payload), null, 2)}</code></pre>
    `;
    new bootstrap.Modal(document.getElementById('viewLicenseModal')).show();
}

function confirmDeleteLicense(button) {
    const id = button.dataset.id;
    licenseToDelete = { id };
    document.getElementById('delete-license-id').textContent = `ID ${id}`;
    new bootstrap.Modal(document.getElementById('deleteLicenseModal')).show();
}

function filterLicenses() {
    const tenantId = document.getElementById('tenant-filter').value;
    const url = tenantId ? `/api/licenses?page=1&size=10&tenant_id=${tenantId}` : '/api/licenses?page=1&size=10';
    htmx.ajax('GET', url, {target: '#licenses-list', swap: 'innerHTML'});
}

function clearFilters() {
    document.getElementById('tenant-filter').value = '';
    htmx.ajax('GET', '/api/licenses?page=1&size=10', {target: '#licenses-list', swap: 'innerHTML'});
}

document.getElementById('confirm-delete-license-btn').addEventListener('click', async function() {
    if (!licenseToDelete) return;

    try {
        const response = await fetch(`/licenses/${licenseToDelete.id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            $('#deleteLicenseModal').modal('hide');
            htmx.trigger('body', 'licensesUpdated');
            showToast('License revoked successfully', 'success');
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to revoke license', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Network error occurred', 'error');
    }

    licenseToDelete = null;
});

// Load tenants and templates on page load
document.addEventListener('DOMContentLoaded', loadTenantsAndTemplates);

// Set default issued_at when modal is shown
document.getElementById('addLicenseModal').addEventListener('show.bs.modal', function() {
    setDefaultIssuedAt();
});

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.getElementById('toast-container').appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
